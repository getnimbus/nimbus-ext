<script lang="ts">
  import { createQuery } from "@tanstack/svelte-query";
  import dayjs from "dayjs";
  import TooltipNumber from "~/components/TooltipNumber.svelte";
  import { nimbus } from "~/lib/network";
  import { user } from "~/store";

  export let selectedAddress;

  let netWorth = 0;
  let unRealizedProfit = 0;
  let set30DayPnl = 0;
  let winRate = 0;
  let totalCost = 0;

  const handleFilter30Day = (item) => {
    const date = dayjs(item?.last_transferred_at);
    const thirtyDaysInMilliseconds = 30 * 24 * 60 * 60 * 1000;
    return (
      thirtyDaysInMilliseconds - dayjs(dayjs()).diff(date, "millisecond") > 0
    );
  };

  const formatDataHoldingToken = (dataTokenHolding) => {
    const formatData = dataTokenHolding
      .map((item) => {
        return {
          ...item,
          value:
            Number(item?.amount) * Number(item?.price?.price || item?.rate),
        };
      })
      .sort((a, b) => {
        if (a.value < b.value) {
          return 1;
        }
        if (a.value > b.value) {
          return -1;
        }
        return 0;
      });

    netWorth = formatData.reduce((prev, item) => prev + item.value, 0);

    const formatWinRate = formatData
      .filter(
        (item) =>
          Number(item.price.price) !== 0 &&
          item?.profit?.realizedProfit !== undefined
      )
      .filter(handleFilter30Day);
    winRate =
      (formatWinRate.filter((item) => item?.profit?.realizedProfit > 0).length /
        formatWinRate.length) *
      100;
  };

  const getTradingStats = async (address) => {
    const response: any = await nimbus.get(
      `/v2/analysis/${address}/trading-stats`
    );
    if (response?.status === 401) {
      throw new Error(response?.response?.error);
    }
    return response?.data;
  };

  const getHoldingToken = async (address) => {
    const response = await nimbus
      .get(`/v2/address/${address}/holding?chain=ALL`)
      .then((response) => response.data);
    return response;
  };

  $: queryTradingStats = createQuery({
    queryKey: ["trading-stats", selectedAddress],
    queryFn: () => getTradingStats(selectedAddress),
    staleTime: Infinity,
    retry: false,
    enabled: selectedAddress?.length !== 0 && Object.keys($user).length !== 0,
    onError(err) {
      localStorage.removeItem("evm_token");
      user.update((n) => (n = {}));
    },
  });

  $: queryTokenHolding = createQuery({
    queryKey: ["token-holding", selectedAddress],
    queryFn: () => getHoldingToken(selectedAddress),
    staleTime: Infinity,
    enabled: selectedAddress?.length !== 0 && Object.keys($user).length !== 0,
  });

  $: profit =
    $queryTradingStats?.data !== undefined
      ? $queryTradingStats?.data?.latestStats?.unrealizedProfit +
        $queryTradingStats?.data?.latestStats?.totalRealizedProfit
      : 0;

  $: {
    if (
      !$queryTokenHolding.isError &&
      $queryTokenHolding.data &&
      $queryTokenHolding?.data !== undefined
    ) {
      formatDataHoldingToken($queryTokenHolding.data);
    }
  }

  $: {
    if ($queryTradingStats?.data) {
      const tradingStatsMeta = $queryTradingStats?.data?.metadata.filter(
        (e) => e.startTrade < 2592000000
      );

      unRealizedProfit = tradingStatsMeta?.reduce(
        (prev, item) => prev + Number(item.unrealizedProfit),
        0
      );

      totalCost = tradingStatsMeta?.reduce(
        (prev, item) => prev + Number(item.cost),
        0
      );

      if (unRealizedProfit === 0 && profit === 0) {
        set30DayPnl = 0;
      } else {
        set30DayPnl = unRealizedProfit + profit - totalCost / totalCost;
      }
    }
  }
</script>

<div
  class="col-span-4 grid grid-cols-5 gap-3 border border_0000001a rounded-xl p-6"
>
  <div class="col-span-3 grid grid-cols-3 gap-3">
    <div class="flex flex-col gap-2 justify-between">
      <span class="text-xl xl:text-xs font-medium text_00000099">Balance</span>
      <span class="xl:text-base text-lg">
        <TooltipNumber number={netWorth} type="value" />
      </span>
    </div>
    <div class="flex flex-col gap-2 justify-between">
      <span class="text-xl xl:text-xs font-medium text_00000099">
        30D Unrealized
      </span>
      <span
        class={`xl:text-base text-lg ${
          unRealizedProfit < 0
            ? "text-red-500"
            : unRealizedProfit > 0
            ? "text-green-400"
            : ""
        }`}
      >
        <TooltipNumber number={unRealizedProfit} type="value" />
      </span>
    </div>
    <div class="flex flex-col gap-2 justify-between">
      <span class="text-xl xl:text-xs font-medium text_00000099">
        30D Realized Profit
      </span>
      <div class="xl:text-base text-lg">
        <div
          class={`${
            profit !== 0
              ? profit >= 0
                ? "text-green-400"
                : "text-red-500"
              : ""
          }`}
        >
          <TooltipNumber number={Math.abs(profit)} type="value" />
        </div>
      </div>
    </div>
  </div>
  <div class="grid grid-cols-2 col-span-2 gap-3">
    <div class="flex flex-col gap-2 justify-between">
      <span class="text-xl xl:text-xs font-medium text_00000099">30D PnL</span>
      <span
        class={`${
          set30DayPnl > 0
            ? "text-green-400"
            : set30DayPnl < 0
            ? "text-red-500"
            : ""
        }`}
      >
        <TooltipNumber number={set30DayPnl} type="percent" />%
      </span>
    </div>
    <div class="flex flex-col gap-2 justify-between">
      <span class="text-xl xl:text-xs font-medium text_00000099">Winrate</span>
      <span class="xl:text-base text-lg">
        <TooltipNumber number={winRate} type="percent" />%
      </span>
    </div>
  </div>
</div>

<style windi:preflights:global windi:safelist:global></style>
