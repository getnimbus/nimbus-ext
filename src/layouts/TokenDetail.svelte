<script lang="ts">
  import { onMount } from "svelte";
  import { nimbus } from "~/lib/network";
  import { Link } from "svelte-navigator";
  import dayjs from "dayjs";
  import {
    shorterAddress,
    formatCurrency,
    formatBalance,
    autoFontSize,
  } from "~/utils";
  import mixpanel from "mixpanel-browser";
  import { isDarkMode } from "~/store";

  import tooltip from "~/entries/contentScript/views/tooltip";
  import Loading from "~/components/Loading.svelte";
  import EChart from "~/components/EChart.svelte";
  import ErrorBoundary from "~/components/ErrorBoundary.svelte";
  import TooltipNumber from "~/components/TooltipNumber.svelte";
  import Copy from "~/components/Copy.svelte";
  import CountUpNumber from "~/components/CountUpNumber.svelte";
  import OverviewCard from "~/components/OverviewCard.svelte";
  import Button from "~/components/Button.svelte";

  import TwitterLogo from "~/assets/twitter.svg";
  import LeftArrow from "~/assets/left-arrow.svg";

  let darkMode = false;
  isDarkMode.subscribe((value) => {
    darkMode = value;
  });

  let type = "";
  let positionDetail;
  let positionDetailPrice;
  let isLoadingPositionDetail = false;
  let isLoadingPositionDetailPrice = false;
  let isEmptyChart = false;
  let isDownPrice = 0;
  let tweet = "";
  let address = "";
  let option = {
    title: {
      text: "",
    },
    tooltip: {
      trigger: "axis",
      extraCssText: "z-index: 9997",
      formatter: function (params) {
        return `
            <div style="display: flex; flex-direction: column; gap: 12px; min-width: 220px;">
              <div style="font-weight: 500; font-size: 16px; line-height: 19px; color: black;">
                ${params[0]?.axisValue}
              </div>
              <div style="display: flex; align-items: centers; justify-content: space-between;">
                <div style="width: 135px; font-weight: 500; font-size: 14px; line-height: 17px; color: black; display: flex; align-items: centers; gap: 6px;">
                  <div style="background: ${
                    params[0]?.color
                  }; width: 12px; height: 12px; border-radius: 100%; margin-top: 3px;"></div>
                  ${params[0]?.seriesName}
                </div>
                <div style="display:flex; justify-content: center; align-items: center; gap: 4px; flex: 1; font-weight: 500; font-size: 14px; line-height: 17px; color: black;">
                  ${formatCurrency(Math.abs(params[0]?.value))}
                </div>
              </div>
              <div style="display: flex; align-items: centers; justify-content: space-between;">
                <div style="width: 135px; font-weight: 500; font-size: 14px; line-height: 17px; color: black; display: flex; align-items: centers; gap: 6px;">
                  <div style="background: ${
                    params[1]?.color
                  }; width: 12px; height: 12px; border-radius: 100%; margin-top: 3px;"></div>
                  ${params[1]?.seriesName}
                </div>
                <div style="display:flex; justify-content: center; align-items: center; gap: 4px; flex: 1; font-weight: 500; font-size: 14px; line-height: 17px; color: black;">
                  ${formatCurrency(Math.abs(params[1]?.value))}
                </div>
              </div>
            </div>`;
      },
    },
    legend: {
      lineStyle: {
        type: "solid",
      },
      data: [],
    },
    grid: {
      left: "3%",
      right: "4%",
      bottom: "3%",
      containLabel: true,
    },
    xAxis: {
      type: "category",
      boundaryGap: false,
      data: [],
      axisLabel: {
        fontSize: autoFontSize(),
      },
    },
    yAxis: [
      {
        type: "value",
        name: "Price",
        position: "right",
        offset: 10,
        alignTicks: true,
        axisLabel: {
          formatter: "${value}",
          fontSize: autoFontSize(),
        },
      },
      {
        type: "value",
        name: "Balance",
        position: "left",
        alignTicks: true,
        axisLabel: {
          formatter: "{value}",
          fontSize: autoFontSize(),
        },
      },
    ],
    series: [],
  };
  let option2 = {
    ...option,
    tooltip: {
      trigger: "axis",
      extraCssText: "z-index: 9997",
      formatter: function (params) {
        return `
            <div style="display: flex; flex-direction: column; gap: 12px; min-width: 220px;">
              <div style="font-weight: 500; font-size: 16px; line-height: 19px; color: black;">
                ${params[0].axisValue}
              </div>
              <div style="display: flex; align-items: centers; justify-content: space-between;">
                <div style="width: 135px; font-weight: 500; font-size: 14px; line-height: 17px; color: black; display: flex; align-items: centers; gap: 6px;">
                  <div style="background: ${
                    params[0].color
                  }; width: 12px; height: 12px; border-radius: 100%; margin-top: 3px;"></div>
                  ${params[0].seriesName}
                </div>
                <div style="display:flex; justify-content: center; align-items: center; gap: 4px; flex: 1; font-weight: 500; font-size: 14px; line-height: 17px; color: black;">
                  ${formatCurrency(Math.abs(params[0].value))}
                </div>
              </div>
            </div>`;
      },
    },
  };

  const getPositionDetailPrice = async (positionId, address) => {
    try {
      isLoadingPositionDetailPrice = true;
      const response = await nimbus
        .get(`/address/${address}/token/${positionId}`)
        .then((res) => res.data);
      if (response) {
        positionDetailPrice = response;

        if (response.length === 0) {
          isEmptyChart = true;
        }

        const formatXAxis = response?.balances.map((item) => {
          return dayjs(new Date(item.timestamp * 1000)).format(
            "DD/MM/YY hh:mm A"
          );
        });

        const lastPrice =
          (response?.prices &&
            response?.prices[response?.prices?.length - 1]) ||
          [];
        const firstPrice = (response?.prices && response?.prices[0]) || [];

        isDownPrice = firstPrice[1] - lastPrice[1];

        option = {
          ...option,
          legend: {
            ...option.legend,
            data: [
              {
                name: "Price",
                itemStyle: {
                  color: `${isDownPrice > 0 ? "#EF4444" : "#22c55e"}`,
                },
              },
              {
                name: "Balance",
                itemStyle: {
                  color: "rgba(178,184,255,1)",
                },
              },
            ],
          },
          xAxis: {
            ...option.xAxis,
            data: formatXAxis,
          },
          series: [
            {
              name: "Price",
              type: "line",
              lineStyle: {
                type: "solid",
                color: `${isDownPrice > 0 ? "#EF4444" : "#22c55e"}`,
              },
              showSymbol: false,
              tooltip: {
                valueFormatter: function (value) {
                  return value ? "$" + value : "--";
                },
              },
              data: response?.prices.map((item) => {
                return {
                  value: item?.price,
                  itemStyle: {
                    color: `${isDownPrice > 0 ? "#EF4444" : "#22c55e"}`,
                  },
                };
              }),
            },
            {
              name: "Balance",
              type: "bar",
              barStyle: {
                type: "solid",
                color: "rgba(178,184,255,1)",
              },
              barCategoryGap: "50%",
              yAxisIndex: 1,
              showSymbol: false,
              data: response?.balances.map((item) => {
                return {
                  value: item?.balance,
                  itemStyle: {
                    color: "rgba(178,184,255,1)",
                  },
                };
              }),
            },
          ],
        };

        option2 = {
          ...option2,
          legend: {
            ...option2.legend,
            data: [
              {
                name: "Value",
                itemStyle: {
                  color: "rgba(0,169,236, 0.8)",
                },
              },
            ],
          },
          yAxis: [
            {
              type: "value",
              name: "Value",
              position: "left",
              alignTicks: true,
              axisLabel: {
                formatter: "{value}",
              },
            },
          ],
          xAxis: {
            ...option.xAxis,
            data: formatXAxis,
          },
          series: [
            {
              name: "Value",
              type: "line",
              lineStyle: {
                type: "solid",
                color: "rgba(0,169,236, 0.8)",
              },
              areaStyle: {
                color: "rgba(0,169,236, 0.5)",
              },
              showSymbol: false,
              data: response?.balances.map((item) => {
                return {
                  value: item?.value,
                  itemStyle: {
                    color: "rgba(0,169,236, 0.8)",
                  },
                };
              }),
            },
          ],
        };

        setTimeout(() => {
          syncChartCursor();
        }, 500);
      } else {
        isEmptyChart = true;
      }
    } catch (e) {
      console.error("error: ", e);
      isEmptyChart = true;
    } finally {
      isLoadingPositionDetailPrice = false;
    }
  };

  const syncChartCursor = () => {
    let currentHightLight = null;
    const onChartHighlight = (e, chartName) => {
      const dataIndex = e?.batch?.[0]?.dataIndex;
      if (currentHightLight === dataIndex) {
        return;
      }
      currentHightLight = dataIndex;
      if (chartName === "chartBalance") {
        window.echarts.chartValue.dispatchAction({
          type: "showTip",
          dataIndex,
          seriesIndex: 0,
        });
      } else if (chartName === "chartValue") {
        window.echarts.chartBalance.dispatchAction({
          type: "showTip",
          dataIndex,
          seriesIndex: 1,
        });
      }
    };

    const onMouseOut = () => {
      setTimeout(() => {
        window.echarts?.chartValue?.dispatchAction({
          type: "hideTip",
        });
        window.echarts?.chartBalance?.dispatchAction({
          type: "hideTip",
        });
      }, 200);
    };

    if (window.echarts?.chartBalance) {
      // window.echarts.chartBalance.on("highlight", console.log);
      window.echarts.chartBalance.on("highlight", (e) =>
        onChartHighlight(e, "chartBalance")
      );
      window.echarts.chartBalance.on("mouseout", onMouseOut);
    }
    if (window.echarts?.chartValue) {
      window.echarts.chartValue.on("highlight", (e) =>
        onChartHighlight(e, "chartValue")
      );
      window.echarts.chartValue.on("mouseout", onMouseOut);
    }
  };

  const getPositionDetail = async (positionId, positionType, address) => {
    try {
      isLoadingPositionDetail = true;
      const response = await nimbus
        .get(`/address/${address}/positions/${positionType}/${positionId}`)
        .then((res) => res.data);
      if (response) {
        positionDetail = response;
      }
    } catch (e) {
      console.error("error: ", e);
    } finally {
      isLoadingPositionDetail = false;
    }
  };

  onMount(() => {
    const urlParams = new URLSearchParams(window.location.search);
    let positionIDParams = urlParams.get("id");
    let positionTypeParams = urlParams.get("type");
    let addressParams = urlParams.get("address");

    if (positionIDParams && positionTypeParams && addressParams) {
      mixpanel.track("position_detail_page", {
        address: addressParams,
        position_type: positionTypeParams,
      });
      getPositionDetailPrice(positionIDParams, addressParams);
      getPositionDetail(positionIDParams, positionTypeParams, addressParams);
      address = addressParams;
      type = positionTypeParams;
      tweet = `Check it out on Nimbus 🚀 @get_nimbus https://app.getnimbus.io/position-detail?positionId=${positionIDParams}&positionType=${positionTypeParams}&address=${addressParams}`;
    }
  });
</script>

<ErrorBoundary>
  <div class="header-container">
    <div class="flex flex-col max-w-[2000px] m-auto xl:w-[82%] w-[90%]">
      <div class="flex flex-col mb-5 gap-14">
        <div class="flex items-center justify-between">
          <Link to="/" class="cusor-pointer">
            <div class="flex items-center gap-1 text-white">
              <img src={LeftArrow} alt="" class="xl:w-5 xl:h-5 w-7 h-7" />
              <div class="text-xl font-medium xl:text-sm">
                Back to Portfolio
              </div>
            </div>
          </Link>
        </div>
        <div class="flex items-center justify-between">
          <div class="flex flex-col gap-3">
            <div class="flex items-center gap-2 text-white">
              <img
                src={positionDetail?.logo}
                alt=""
                class="w-10 h-10 rounded-full"
              />
              <div class="text-3xl font-medium">
                {positionDetail?.price?.symbol || "-"}
              </div>
            </div>
            {#if address}
              <div class="text-base">
                <Copy
                  {address}
                  iconColor={`${darkMode ? "#fff" : "#000"}`}
                  color={`${darkMode ? "#fff" : "#000"}`}
                />
              </div>
            {/if}
          </div>
          <a
            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(
              tweet
            )}`}
            target="_blank"
            class="flex justify-end"
          >
            <img src={TwitterLogo} alt="" class="rounded-full w-9 h-9" />
          </a>
        </div>
      </div>
      <div class="flex flex-col justify-between gap-6 xl:flex-row">
        <div class="flex flex-col justify-between flex-1 gap-6 md:flex-row">
          <OverviewCard title={"Position Value"}>
            <div class="flex items-end gap-1 text-5xl xl:text-3xl">
              {#if (positionDetail?.overview?.holding)
                .toString()
                .toLowerCase()
                .includes("e-")}
                <TooltipNumber
                  number={positionDetail?.overview?.holding}
                  type="balance"
                />
                <span class="text-xl text-gray-500"
                  >{positionDetail?.price?.symbol || ""}</span
                >
              {:else}
                <CountUpNumber
                  id="PositionValueHolding"
                  number={positionDetail?.overview?.holding}
                  type="balance"
                />
                <span class="text-xl text-gray-500"
                  >{positionDetail?.price?.symbol || ""}</span
                >
              {/if}
            </div>
            <div class="flex text-3xl xl:text-lg">
              $<CountUpNumber
                id="PositionValue"
                number={positionDetail?.overview?.currentValue}
                type="balance"
              />
            </div>
          </OverviewCard>
          <OverviewCard
            title={"Average Cost"}
            link="https://docs.getnimbus.io/metrics/average_cost/"
            isTooltip
          >
            <div class="flex text-5xl xl:text-3xl">
              {#if (positionDetail?.overview?.averageCost)
                .toString()
                .toLowerCase()
                .includes("e-")}
                $<TooltipNumber
                  number={positionDetail?.overview?.averageCost}
                  type="balance"
                />
              {:else}
                $<CountUpNumber
                  id="AverageCost"
                  number={positionDetail?.overview?.averageCost}
                  format={8}
                  type="balance"
                />
              {/if}
            </div>
          </OverviewCard>
        </div>
        <div class="flex flex-col justify-between flex-1 gap-6 md:flex-row">
          <OverviewCard
            title={"Realized PnL"}
            link="https://docs.getnimbus.io/metrics/holding_profit_loss/"
            tooltipText="Profit and loss is calculated by transactions that swap the tokens. "
            isTooltip
          >
            <div
              class={`xl:text-3xl text-5xl flex ${
                positionDetail?.overview?.profitAndLoss?.percent >= 0
                  ? "text-[#00A878]"
                  : "text-red-500"
              }`}
            >
              $<CountUpNumber
                id="Profit&Loss"
                number={Math.abs(
                  positionDetail?.overview?.profitAndLoss?.value
                )}
                type="balance"
              />
            </div>
            <div
              class={`xl:text-lg text-3xl flex ${
                positionDetail?.overview?.profitAndLoss?.percent >= 0
                  ? "text-[#00A878]"
                  : "text-red-500"
              }`}
            >
              {#if positionDetail?.overview?.profitAndLoss?.percent < 0}
                ↓
              {:else}
                ↑
              {/if}
              <CountUpNumber
                id="Profit&LossPercent"
                number={Math.abs(
                  positionDetail?.overview?.profitAndLoss?.percent
                ) * 100}
                type="percent"
              />%
            </div>
          </OverviewCard>
          <OverviewCard title={"Unrealized PnL"}>
            <div
              class={`xl:text-3xl text-5xl flex ${
                positionDetail?.overview?.return24h?.percent >= 0
                  ? "text-[#00A878]"
                  : "text-red-500"
              }`}
            >
              $<CountUpNumber
                id="24-hourReturn"
                number={Math.abs(positionDetail?.overview?.return24h?.value)}
                type="balance"
              />
            </div>
            <div
              class={`xl:text-lg text-3xl flex ${
                positionDetail?.overview?.return24h?.percent >= 0
                  ? "text-[#00A878]"
                  : "text-red-500"
              }`}
            >
              {#if positionDetail?.overview?.return24h?.percent < 0}
                ↓
              {:else}
                ↑
              {/if}
              <CountUpNumber
                id="24-hourReturnPercent"
                number={Math.abs(positionDetail?.overview?.return24h?.percent) *
                  100}
                type="percent"
              />%
            </div>
          </OverviewCard>
        </div>
      </div>
    </div>
  </div>
  <div class="max-w-[2000px] m-auto xl:w-[90%] w-[90%] -mt-26">
    <div
      class="flex flex-col gap-7 bg-white rounded-[20px] xl:p-8 p-6 mt-6"
      style="box-shadow: 0px 0px 40px 0px rgba(0, 0, 0, 0.10);"
    >
      <div class="flex flex-col justify-between gap-6 xl:flex-row">
        <div class="xl:w-1/2 w-full border border_0000001a rounded-[20px] p-6">
          <div class="pl-4 mb-3 text-4xl font-medium xl:text-2xl">
            Price & Total Balance
          </div>
          {#if isLoadingPositionDetailPrice}
            <div class="flex justify-center items-center h-[504px]">
              <Loading />
            </div>
          {:else}
            <div>
              {#if isEmptyChart}
                <div
                  class="flex justify-center items-center text-lg text-gray-400 h-[504px]"
                >
                  Empty
                </div>
              {:else}
                <EChart
                  id="chartBalance"
                  theme="white"
                  {option}
                  height={420}
                  notMerge={true}
                />
              {/if}
            </div>
          {/if}
        </div>
        <div class="xl:w-1/2 w-full border border_0000001a rounded-[20px] p-6">
          <div class="pl-4 mb-3 text-4xl font-medium xl:text-2xl">
            Position Value
          </div>
          {#if isLoadingPositionDetailPrice}
            <div class="flex justify-center items-center h-[504px]">
              <Loading />
            </div>
          {:else}
            <div>
              {#if isEmptyChart}
                <div
                  class="flex justify-center items-center text-lg text-gray-400 h-[504px]"
                >
                  Empty
                </div>
              {:else}
                <EChart
                  id="chartValue"
                  theme="white"
                  option={option2}
                  height={420}
                  notMerge={true}
                />
              {/if}
            </div>
          {/if}
        </div>
      </div>

      <div>
        
      </div>
      <div class="border border_0000001a rounded-[20px] p-6">
        <div class="flex flex-col gap-6">
          <div class="flex items-center justify-between">
            <div class="text-4xl font-medium xl:text-2xl">History</div>
            <div
              use:tooltip={{
                content: `<tooltip-detail text="Premium feature. Coming soon" />`,
                allowHTML: true,
                placement: "top",
              }}
            >
              <Button variant="premium">Export Data</Button>
            </div>
          </div>

          {#if type === "ERC_20"}
            <div class="border border_0000000d rounded-[10px] overflow-x-auto">
              <table class="table-auto xl:w-full w-[1200px]">
                <thead>
                  <tr class="bg_f4f5f8">
                    <th
                      class="sticky left-0 py-3 pl-3 xl:static xl:bg-transparent z-9 bg_f4f5f8"
                    >
                      <div
                        class="text-xl font-medium text-left uppercase xl:text-xs"
                      >
                        Transaction
                      </div>
                    </th>
                    <th class="py-3">
                      <div
                        class="text-xl font-medium text-left uppercase xl:text-xs"
                      >
                        From
                      </div>
                    </th>
                    <th class="py-3">
                      <div
                        class="text-xl font-medium text-left uppercase xl:text-xs"
                      >
                        To
                      </div>
                    </th>
                    <th class="py-3 min-w-[100px]">
                      <div
                        class="text-xl font-medium text-left uppercase xl:text-xs"
                      >
                        Type
                      </div>
                    </th>
                    <th class="py-3 pr-3">
                      <div
                        class="text-xl font-medium text-left uppercase xl:text-xs"
                      >
                        Token change
                      </div>
                    </th>
                  </tr>
                </thead>
                {#if isLoadingPositionDetail}
                  <tbody>
                    <tr>
                      <td colspan={5}>
                        <div class="flex items-center justify-center px-3 py-4">
                          <Loading />
                        </div>
                      </td>
                    </tr>
                  </tbody>
                {:else}
                  <tbody>
                    {#if positionDetail?.changes && positionDetail?.changes.length === 0}
                      <tr>
                        <td colspan={5}>
                          <div
                            class="flex items-center justify-center px-3 py-4 text-lg text-gray-400"
                          >
                            Empty
                          </div>
                        </td>
                      </tr>
                    {:else}
                      {#each positionDetail?.changes || [] as change}
                        <tr
                          class="group transition-all border-b-[0.5px] border_0000000d last:border-none"
                        >
                          <td
                            class={`sticky left-0 py-3 pl-3 xl:static xl:bg-transparent z-9  ${
                              darkMode
                                ? "bg-[#110c2a] group-hover:bg-[#000]"
                                : "bg-white group-hover:bg-gray-100"
                            }`}
                          >
                            <div class="flex items-start gap-2 text-left w-max">
                              <div class="flex flex-col">
                                <div class="text-xl xl:text-sm">
                                  <Copy
                                    address={change?.transaction_hash}
                                    textTooltip="Copy transaction to clipboard"
                                    iconColor={`${darkMode ? "#fff" : "#000"}`}
                                    color={`${darkMode ? "#fff" : "#000"}`}
                                    isShorten={true}
                                    isLink={true}
                                    link={`https://etherscan.io/tx/${change?.transaction_hash}`}
                                  />
                                </div>
                                <div class="text-lg text-gray-400 xl:text-xs">
                                  {dayjs(
                                    new Date(change?.detail.timestamp)
                                  ).format("YYYY-MM-DD, hh:mm A")}
                                </div>
                              </div>
                            </div>
                          </td>

                          <td
                            class={`py-3 ${
                              darkMode
                                ? "group-hover:bg-[#000]"
                                : "group-hover:bg-gray-100"
                            }`}
                          >
                            {#if change?.detail?.from}
                              <div class="text-xl xl:text-sm w-max">
                                <Copy
                                  address={change?.detail?.from}
                                  iconColor={`${darkMode ? "#fff" : "#000"}`}
                                  color={`${darkMode ? "#fff" : "#000"}`}
                                  isShorten={true}
                                  isLink={true}
                                  link={`https://etherscan.io/address/${change?.detail?.from}`}
                                />
                              </div>
                            {/if}
                          </td>

                          <td
                            class={`py-3 ${
                              darkMode
                                ? "group-hover:bg-[#000]"
                                : "group-hover:bg-gray-100"
                            }`}
                          >
                            {#if change?.detail?.to}
                              <div class="text-xl xl:text-sm w-max">
                                <Copy
                                  address={change?.detail?.to}
                                  iconColor={`${darkMode ? "#fff" : "#000"}`}
                                  color={`${darkMode ? "#fff" : "#000"}`}
                                  isShorten={true}
                                  isLink={true}
                                  link={`https://etherscan.io/address/${change?.detail?.to}`}
                                />
                              </div>
                            {/if}
                          </td>

                          <td
                            class={`py-3 min-w-[100px] ${
                              darkMode
                                ? "group-hover:bg-[#000]"
                                : "group-hover:bg-gray-100"
                            }`}
                          >
                            <div
                              class="flex justify-start text-2xl font-medium xl:text-sm text_00000099"
                            >
                              {#if change?.type}
                                <div
                                  class="w-max px-2 py-1 text_27326F xl:text-[12px] text-lg font-normal bg-[#6AC7F533] rounded-[5px] capitalize"
                                >
                                  {change?.type}
                                </div>
                              {/if}
                            </div>
                          </td>

                          <td
                            class={`py-3 pr-3 ${
                              darkMode
                                ? "group-hover:bg-[#000]"
                                : "group-hover:bg-gray-100"
                            }`}
                          >
                            <div
                              class="flex flex-col items-start gap-2 text-xl font-medium xl:text-sm"
                            >
                              {#each change.changes as item}
                                <div class="flex items-center gap-2">
                                  <img
                                    src={item?.logo}
                                    alt=""
                                    class="object-contain overflow-hidden rounded-full w-7 h-7"
                                  />
                                  <div
                                    class={`flex gap-1 ${
                                      item?.total < 0
                                        ? "text_00000099"
                                        : "text-[#00A878]"
                                    }`}
                                  >
                                    <span
                                      >{item?.total < 0
                                        ? "-"
                                        : "+"}<TooltipNumber
                                        number={Math.abs(item?.total)}
                                        type="balance"
                                      />
                                      {item?.symbol || item?.name || "⎯"}
                                    </span>
                                    <span class="flex">
                                      ($<TooltipNumber
                                        number={Math.abs(
                                          item?.total * item?.price?.price
                                        )}
                                        type="balance"
                                      />)
                                    </span>
                                  </div>
                                </div>
                              {/each}
                            </div>
                          </td>
                        </tr>
                      {/each}
                    {/if}
                  </tbody>
                {/if}
              </table>
            </div>
          {:else}
            <div class="border border_0000000d rounded-[10px]">
              <table class="w-full table-auto">
                <thead>
                  <tr class="bg_f4f5f8">
                    <th class="py-3 pl-3">
                      <div
                        class="text-xl font-medium text-left uppercase xl:text-xs"
                      >
                        Transaction
                      </div>
                    </th>
                    <th class="py-3">
                      <div
                        class="text-xl font-medium text-left uppercase xl:text-xs"
                      >
                        Type
                      </div>
                    </th>
                    <th class="py-3 pr-3">
                      <div
                        class="text-xl font-medium text-left uppercase xl:text-xs"
                      >
                        Token Change
                      </div>
                    </th>
                  </tr>
                </thead>
                {#if isLoadingPositionDetail}
                  <tbody>
                    <tr>
                      <td colspan="3">
                        <div class="flex items-center justify-center px-3 py-4">
                          <Loading />
                        </div>
                      </td>
                    </tr>
                  </tbody>
                {:else}
                  <tbody>
                    {#if positionDetail?.changes && positionDetail?.changes.length === 0}
                      <tr>
                        <td colspan="3">
                          <div
                            class="flex items-center justify-center px-3 py-4 text-lg text-gray-400"
                          >
                            Empty
                          </div>
                        </td>
                      </tr>
                    {:else}
                      {#each positionDetail?.changes || [] as change}
                        <tr
                          class="group transition-all border-b-[0.5px] border_0000000d last:border-none"
                        >
                          <td
                            class={`py-3 pl-3 ${
                              darkMode
                                ? "group-hover:bg-[#000]"
                                : "group-hover:bg-gray-100"
                            }`}
                          >
                            <div class="w-max">
                              <a
                                href={`https://www.oklink.com/btc/tx/${change?.transactionHash}`}
                                class="cursor-pointer hover:text-blue-500"
                                target="_blank"
                              >
                                <div class="flex items-start gap-2 text-left">
                                  <div class="flex flex-col">
                                    <div
                                      class="text-xl xl:text-sm"
                                      use:tooltip={{
                                        content: `<tooltip-detail text="${change?.transactionHash}" />`,
                                        allowHTML: true,
                                        placement: "top-start",
                                      }}
                                    >
                                      {shorterAddress(change?.transactionHash)}
                                    </div>
                                    <div
                                      class="text-lg text-gray-400 xl:text-xs"
                                    >
                                      {dayjs(new Date(change.timestamp)).format(
                                        "YYYY-MM-DD, hh:mm A"
                                      )}
                                    </div>
                                  </div>
                                </div>
                              </a>
                            </div>
                          </td>
                          <td
                            class={`py-3 ${
                              darkMode
                                ? "group-hover:bg-[#000]"
                                : "group-hover:bg-gray-100"
                            }`}
                          >
                            {#if change?.metadata?.action}
                              <div
                                class="w-max px-2 py-1 text_27326F xl:text-[12px] text-lg font-normal bg-[#6AC7F533] rounded-[5px] capitalize"
                              >
                                {change?.metadata?.action}
                              </div>
                            {/if}
                          </td>
                          <td
                            class={`py-3 pr-3${
                              darkMode
                                ? "group-hover:bg-[#000]"
                                : "group-hover:bg-gray-100"
                            }`}
                          >
                            <div class="w-max">
                              <a
                                href={`https://www.oklink.com/btc/tx/${change?.transactionHash}`}
                                target="_blank"
                                class="cursor-pointer"
                              >
                                <div
                                  class="flex flex-col items-start justify-start gap-1 text-xl xl:text-sm"
                                >
                                  {#if change?.metadata?.hasOwnProperty("btcChange")}
                                    <div class="flex items-center gap-1">
                                      <div
                                        class={`flex items-center gap-1 ${
                                          change?.metadata?.btcChange
                                            ?.final_result >= 0
                                            ? "text-[#00A878]"
                                            : "text-red-500"
                                        }`}
                                      >
                                        <TooltipNumber
                                          number={Math.abs(
                                            change?.metadata?.btcChange
                                              ?.final_result
                                          )}
                                          type="balance"
                                        />
                                        <div>
                                          {change?.metadata?.btcPrice?.symbol}
                                        </div>
                                      </div>
                                      <div class="flex text-gray-500">
                                        | $<TooltipNumber
                                          number={Math.abs(
                                            change?.metadata?.btcChange
                                              ?.final_result *
                                              Number(
                                                change?.metadata?.btcPrice
                                                  ?.price
                                              )
                                          )}
                                          type="balance"
                                        />
                                      </div>
                                    </div>
                                  {/if}

                                  <div class="flex items-center gap-1">
                                    <div
                                      class={`flex items-center gap-1 ${
                                        change.event === "deposit"
                                          ? "text-[#00A878]"
                                          : "text-red-500"
                                      }`}
                                    >
                                      <TooltipNumber
                                        number={Math.abs(
                                          change?.metadata?.info?.total
                                        )}
                                        type="balance"
                                      />
                                      <div>
                                        {change?.metadata?.info?.tokenName}
                                      </div>
                                    </div>
                                    <div class="flex text-gray-500">
                                      | $<TooltipNumber
                                        number={Math.abs(
                                          change?.metadata?.info?.total *
                                            Number(
                                              change?.metadata?.price?.price
                                            )
                                        )}
                                        type="balance"
                                      />
                                    </div>
                                  </div>
                                </div>
                              </a>
                            </div>
                          </td>
                        </tr>
                      {/each}
                    {/if}
                  </tbody>
                {/if}
              </table>
            </div>
          {/if}
        </div>
      </div>
    </div>
  </div>
</ErrorBoundary>

<style>
  .header-container {
    background-image: url("~/assets/capa.svg");
    background-color: #27326f;
    background-repeat: no-repeat;
    background-size: auto;
    background-position: top right;
    padding-bottom: 144px;
    padding-top: 24px;
  }
</style>
