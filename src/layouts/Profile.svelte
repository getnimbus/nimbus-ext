<script lang="ts">
  import { onMount } from "svelte";
  import { shorterAddress } from "~/utils/index";
  import { triggerToast, triggerClickOutside } from "~/utils/functions";
  import { nimbus } from "~/lib/network";
  import { createQuery } from "@tanstack/svelte-query";
  import {
    user,
    isDarkMode,
    typeWallet,
    userId,
    userPublicAddress,
    chain,
  } from "~/store";
  import { flatMap } from "lodash";
  import { detectedGeneration } from "~/lib/chains";
  import {
    handleValidateAddress,
    getHoldingNFT,
    getListAddress,
  } from "~/lib/queryAPI";

  import ProfitData from "~/UI/Profile/ProfitData.svelte";
  import InviterQr from "~/UI/Profile/InviterQR.svelte";
  import Summary from "~/UI/Profile/Summary.svelte";
  import SocialMedia from "~/UI/Profile/SocialMedia.svelte";
  import ClosedPositionChart from "~/UI/Profile/ClosedPositionChart.svelte";
  import TopProfitAndLoss from "~/UI/Profile/TopProfitAndLoss.svelte";
  import Button from "~/components/Button.svelte";
  import AppOverlay from "~/components/Overlay.svelte";
  import Loading from "~/components/Loading.svelte";
  import TooltipNumber from "~/components/TooltipNumber.svelte";
  import ErrorBoundary from "~/components/ErrorBoundary.svelte";

  import User from "~/assets/user.png";
  import UpArrow from "~/assets/up-arrow.svg";

  let userProfile: any = {};
  let dataNftHighlight = {};
  let dataNftHolding = [];
  let listAddress = [];
  let showPopover = false;
  let isEdit = false;
  let isLoadingSaveProfile = false;
  let isOpenModalSelectNFT = false;

  let userIdParams = "";
  let selectedAddress = "";
  let description = "What's on your mind?";
  let selectProfileNFT: any = {};
  let socialDataTwitter = {
    label: "Twitter",
    username: "",
  };
  let socialDataTelegram = {
    label: "Telegram",
    username: "",
  };

  onMount(() => {
    const urlParams = new URLSearchParams(window.location.search);
    let idParams = urlParams.get("id");
    if (idParams) {
      userIdParams = idParams;
      getUserProfile(idParams);
    }
  });

  const submitSocialData = (data) => {
    if (data.type === "Twitter") {
      socialDataTwitter = {
        label: data.label,
        username: data.username,
      };
    }
    if (data.type === "Telegram") {
      socialDataTelegram = {
        label: data.label,
        username: data.username,
      };
    }
  };

  const handleSubmitProfile = async () => {
    isLoadingSaveProfile = true;
    try {
      const payload = {
        intro: description,
        profileAddress: selectedAddress,
        social: {
          twitter: {
            id: socialDataTwitter.username,
            status: socialDataTwitter.label,
          },
          telegram: {
            id: socialDataTelegram.username,
            status: socialDataTelegram.label,
          },
        },
        highlightNft: {
          chain: selectProfileNFT?.chain,
          tokenId: selectProfileNFT?.tokenId?.toString(),
          contractAddress: selectProfileNFT?.contractAddress,
        },
      };

      await nimbus.put(`/users/${userIdParams}/profile`, payload);
      triggerToast("Your profile updated successfully!", "success");
    } catch (e) {
      console.error(e);
      triggerToast(
        "Something wrong when updating your profile. Please try again!",
        "fail"
      );
    } finally {
      isLoadingSaveProfile = false;
      isEdit = false;
    }
  };

  const handleCancelEditProfile = () => {
    isEdit = false;

    selectedAddress = userProfile?.profileAddress || $userPublicAddress;
    selectProfileNFT = dataNftHighlight;
    description = userProfile?.intro || "What's on your mind?";
    socialDataTelegram = {
      label: userProfile.social?.telegram?.status || "Telegram",
      username: userProfile.social?.telegram?.id || "",
    };
    socialDataTwitter = {
      label: userProfile.social?.twitter?.status || "Twitter",
      username: userProfile.social?.twitter?.id || "",
    };
  };

  const getUserProfile = async (id) => {
    try {
      const response: any = await nimbus.get(`/users/${id}/profile`);
      userProfile = response?.data;

      selectedAddress = userProfile?.profileAddress || $userPublicAddress;
      description = userProfile?.intro || "What's on your mind?";
      socialDataTelegram = {
        label: userProfile.social?.telegram?.status || "Telegram",
        username: userProfile.social?.telegram?.id || "",
      };
      socialDataTwitter = {
        label: userProfile.social?.twitter?.status || "Twitter",
        username: userProfile.social?.twitter?.id || "",
      };
    } catch (e) {
      console.error(e);
    }
  };

  $: queryValidate = createQuery({
    queryKey: ["validate", selectedAddress],
    queryFn: () => handleValidateAddress(selectedAddress),
    staleTime: Infinity,
    retry: false,
    enabled: Boolean(selectedAddress && selectedAddress?.length !== 0),
  });

  const formatDataListAddress = (data) => {
    listAddress = data.map((item) => {
      return {
        id: item.id,
        type: item.type,
        label: item.label,
        value: item.type === "CEX" ? item.id : item.accountId,
        logo: item.type === "CEX" ? item.logo : detectedGeneration(item.type),
      };
    });
  };

  const formatDataHoldingNFT = (data) => {
    const flattenData = flatMap(data, (item) => {
      return item.tokens.map((token) => ({
        ...item,
        ...token,
      }));
    });

    dataNftHolding = flattenData.map((item) => {
      return {
        chain: item?.collection?.chain || "",
        tokenId: item?.tokenId || "",
        contractAddress: item?.contractAddress || "",

        imageUrl:
          item?.imageUrl ||
          "https://i.seadn.io/gae/TLlpInyXo6n9rzaWHeuXxM6SDoFr0cFA0TWNpFQpv5-oNpXlYKzxsVUynd0XUIYBW2G8eso4-4DSQuDR3LC_2pmzfHCCrLBPcBdU?auto=format&dpr=1&w=384",
        rarityScore: item?.rarityScore || 0,
        name: item?.name || "",
        collection: item?.collection || {},
        nativeToken: item?.nativeToken || {},
        marketPrice: item?.marketPrice || 0,
        floorPrice: item?.floorPrice || 0,
        price: item?.price || 0,
        cost: item?.cost || 0,
      };
    });
  };

  // query nft holding
  $: queryNftHolding = createQuery({
    queryKey: ["nft-holding", selectedAddress],
    queryFn: () => getHoldingNFT(selectedAddress, $chain, $queryValidate.data),
    staleTime: Infinity,
    enabled:
      selectedAddress?.length !== 0 &&
      Object.keys($user).length !== 0 &&
      !$queryValidate.isFetching,
  });

  $: {
    if (!$queryNftHolding.isError && $queryNftHolding.data !== undefined) {
      formatDataHoldingNFT($queryNftHolding.data);
    }
  }

  // query list address
  $: query = createQuery({
    queryKey: ["list-address"],
    queryFn: () => getListAddress(),
    staleTime: Infinity,
    enabled: $user && Object.keys($user).length !== 0,
  });

  $: {
    if (
      !$query.isError &&
      $query.data !== undefined &&
      $query.data.length !== 0
    ) {
      formatDataListAddress($query.data);
    }
  }

  $: {
    if (
      Object.keys(userProfile)?.length !== 0 &&
      userProfile?.highlightNft !== null &&
      Object.keys(userProfile?.highlightNft)?.length !== 0 &&
      dataNftHolding.length !== 0
    ) {
      dataNftHighlight =
        dataNftHolding.find(
          (item) =>
            item.contractAddress.toLowerCase() ===
            userProfile?.highlightNft.contractAddress.toLowerCase()
        ) || {};

      selectProfileNFT = dataNftHighlight;
    }
  }
</script>

<ErrorBoundary>
  <div
    class="xl:min-h-screen max-w-[2000px] m-auto xl:w-[90%] w-[90%] py-8 flex flex-col gap-10"
  >
    <div class="flex flex-col justify-center gap-2">
      <div class="text-4xl font-medium">My Profile</div>
      <div class="xl:text-xl text-2xl">
        One place that aggregates all your personal information
      </div>
    </div>

    <form
      on:submit|preventDefault={handleSubmitProfile}
      class="flex flex-col gap-4"
    >
      {#if Object.keys($user).length !== 0 && $userId === userIdParams}
        <div class="flex items-center justify-end lg:gap-2 gap-6">
          {#if isEdit}
            <div class="w-[120px]">
              <Button variant="secondary" on:click={handleCancelEditProfile}>
                Cancel
              </Button>
            </div>
            <div class="w-[120px]">
              <Button
                type="submit"
                isLoading={isLoadingSaveProfile}
                disabled={isLoadingSaveProfile}
              >
                Save
              </Button>
            </div>
          {:else}
            <div class="xl:w-[160px] w-[220px]">
              <Button on:click={() => (isEdit = true)}>
                Edit your profile
              </Button>
            </div>
          {/if}
        </div>
      {/if}

      <div
        class="w-full flex xl:flex-row flex-col rounded-xl py-10 xl:px-10 px-4 gap-9 border-2 border_0000001a"
      >
        <div class="xl:w-[20%] w-full flex flex-col gap-5 items-center">
          <div class="flex flex-col gap-3 items-center justify-start">
            <div class="xl:w-[80px] xl:h-[80px] w-32 h-32">
              <img src={User} alt="" class="object-cover w-full h-full" />
            </div>

            <div
              class={`relative py-1 ${isEdit ? "button" : ""}`}
              on:click={() => {
                if (isEdit) {
                  showPopover = !showPopover;
                }
              }}
            >
              <div
                class={`text-lg xl:text-base font-medium flex items-center gap-2 ${
                  $isDarkMode || isEdit ? "text-white" : "text-black"
                }`}
              >
                {shorterAddress(selectedAddress)}
                {#if isEdit}
                  <img
                    src={UpArrow}
                    alt=""
                    class="transform rotate-180 xl:w-3 xl:h-3 w-5 h-5"
                    class:rotate-0={showPopover}
                  />
                {/if}
              </div>

              {#if showPopover}
                <div
                  class="select_content mt-2 absolute left-1/2 transform -translate-x-1/2 z-8 flex flex-col xl:gap-3 gap-6 px-3 xl:py-2 py-3 text-sm transform rounded-lg top-8 w-max xl:max-h-[310px] max-h-[380px]"
                  style="box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.15); overflow-y: overlay;"
                  use:triggerClickOutside
                  on:click_outside={() => (showPopover = false)}
                >
                  {#each listAddress as item}
                    <div
                      class="cursor-pointer"
                      on:click={() => {
                        selectedAddress = item.value;

                        description = "What's on your mind?";
                        selectProfileNFT = {};
                        socialDataTwitter = {
                          label: "Twitter",
                          username: "",
                        };
                        socialDataTelegram = {
                          label: "Telegram",
                          username: "",
                        };

                        showPopover = false;
                      }}
                    >
                      <div class="flex items-start gap-1">
                        <img
                          src={item.logo}
                          alt=""
                          class="w-5 h-5 xl:w-4 xl:h-4 rounded-full"
                        />
                        <div class="flex flex-col">
                          <div
                            class="xl:text-xs text-sm font-medium text_00000099"
                          >
                            {item.label}
                          </div>
                          <div
                            class={`xl:text-sm text-base ${
                              $isDarkMode ? "text-white" : "text-black"
                            }`}
                          >
                            {shorterAddress(item?.value)}
                          </div>
                        </div>
                      </div>
                    </div>
                  {/each}
                </div>
              {/if}
            </div>
          </div>

          <InviterQr />
        </div>
        <div class="flex-1 flex flex-col gap-4">
          <div class="text-3xl font-medium">My Story</div>
          <div class="grid grid-cols-4 gap-6">
            <Summary {selectedAddress} />

            <div
              class="xl:col-span-2 col-span-4 p-5 rounded-xl border border_0000001a"
            >
              {#if selectProfileNFT && Object.keys(selectProfileNFT).length !== 0}
                <div class="h-full flex sm:flex-row flex-col gap-3">
                  <div
                    class="sm:w-2/5 w-full flex flex-col gap-2 justify-center items-center"
                  >
                    <img
                      src={selectProfileNFT?.imageUrl}
                      alt=""
                      class="rounded-xl w-full h-[200px] object-contain"
                    />
                    {#if isEdit}
                      <div class="w-max">
                        <Button
                          variant="secondary"
                          on:click={() => (isOpenModalSelectNFT = true)}
                        >
                          Change
                        </Button>
                      </div>
                    {/if}
                  </div>
                  <div
                    class="flex-1 w-full h-full flex flex-col justify-center gap-5"
                  >
                    <div class="flex flex-col">
                      <div class="font-medium text-lg">
                        {selectProfileNFT?.name}
                      </div>
                      <div class="flex items-center gap-2 text-lg font-medium">
                        <div>
                          {$typeWallet === "EVM" || $typeWallet === "MOVE"
                            ? "Token ID"
                            : "Inscription"}
                        </div>
                        <div>
                          #{selectProfileNFT?.tokenId}
                        </div>
                      </div>
                    </div>

                    <div class="flex flex-col gap-2">
                      <div class="flex justify-between">
                        <div class="text-gray-400">Rarity</div>
                        <div>{selectProfileNFT?.rarityScore}</div>
                      </div>

                      <div class="flex justify-between">
                        <div class="text-gray-400">Floor Price</div>
                        <div class="flex items-center">
                          <TooltipNumber
                            number={Number(selectProfileNFT?.floorPrice)}
                            type="balance"
                          />
                          <span class="ml-1">
                            {selectProfileNFT?.nativeToken?.symbol || ""}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              {:else}
                <div
                  class="flex flex-col justify-center items-center gap-2 w-full h-full"
                >
                  <div>There is no NFT highlight yet in your profile</div>
                  {#if Object.keys($user).length !== 0 && isEdit}
                    <div class="w-max">
                      <Button
                        variant="tertiary"
                        on:click={() => (isOpenModalSelectNFT = true)}
                      >
                        Add NFT
                      </Button>
                    </div>
                  {/if}
                </div>
              {/if}
            </div>

            <div
              class="xl:col-span-2 col-span-4 p-6 bg-dark-50 text-white rounded-xl"
            >
              {#if isEdit}
                <textarea
                  maxlength="300"
                  rows="5"
                  value={description}
                  class="bg-dark-50 text-white rounded-lg border-0 outline-none w-full"
                  on:change={({ target: { value } }) => (description = value)}
                />
              {:else}
                <div>{description}</div>
              {/if}
            </div>

            <div
              class="xl:col-span-2 col-span-4 grid md:grid-cols-2 grid-cols-1 gap-6"
            >
              <SocialMedia
                {isEdit}
                typeSocialMedia="Twitter"
                socialData={socialDataTwitter}
                {submitSocialData}
              />
              <SocialMedia
                {isEdit}
                typeSocialMedia="Telegram"
                socialData={socialDataTelegram}
                {submitSocialData}
              />
            </div>

            <ProfitData {selectedAddress} />

            <TopProfitAndLoss {selectedAddress} />

            <ClosedPositionChart {selectedAddress} />
          </div>
        </div>
      </div>
    </form>
  </div>
</ErrorBoundary>

<!-- Modal select NFT profile -->
<AppOverlay
  clickOutSideToClose
  isOpen={isOpenModalSelectNFT}
  on:close={() => {
    isOpenModalSelectNFT = false;
  }}
>
  <div class="flex flex-col gap-4">
    <div class="xl:title-3 title-2 font-semibold">
      Select your NFT to set your profile
    </div>
    {#if $queryNftHolding.isFetching}
      <div class="flex items-center justify-center h-[465px]">
        <Loading />
      </div>
    {:else}
      <div>
        {#if $queryNftHolding.isError || dataNftHolding.length === 0}
          <div
            class="flex justify-center items-center p-[6px] h-[465px] text-lg text-gray-400"
          >
            Empty
          </div>
        {:else}
          <div class="overflow-y-auto h-[563px] grid grid-cols-3 gap-6">
            {#each dataNftHolding as item}
              <div
                class="rounded-xl border border_0000001a overflow-hidden h-[260px] cursor-pointer"
                on:click={() => {
                  selectProfileNFT = item;
                  isOpenModalSelectNFT = false;
                }}
              >
                <img
                  src={item?.imageUrl}
                  alt=""
                  class="w-full h-full object-contain"
                />
              </div>
            {/each}
          </div>
        {/if}
      </div>
    {/if}
  </div>
</AppOverlay>

<style>
  .button {
    width: max-content;
    border-radius: 1000px;
    padding: 4px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  :global(body) .button {
    background: #20295b;
  }
  :global(body.dark) .button {
    background: #212121;
  }

  :global(body) .select_content {
    background: #ffffff;
    border: 0.5px solid transparent;
  }
  :global(body.dark) .select_content {
    background: #131313;
    border: 0.5px solid #cdcdcd59;
  }
</style>
