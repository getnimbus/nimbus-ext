<script lang="ts">
  import { isDarkMode, user } from "~/store";
  import { shorterAddress } from "~/utils";
  import { Link } from "svelte-navigator";
  import mixpanel from "mixpanel-browser";
  import html2canvas from "html2canvas";

  import InviterQr from "~/UI/Profile/InviterQR.svelte";
  import ClosedPositionChart from "~/UI/Profile/ClosedPositionChart.svelte";
  import TopProfitAndLoss from "~/UI/Profile/TopProfitAndLoss.svelte";
  import ProfitData from "~/UI/Profile/ProfitData.svelte";

  import User from "~/assets/user.png";
  import LeftArrow from "~/assets/left-arrow.svg";
  import LeftArrowBlack from "~/assets/left-arrow-black.svg";

  import SyncData from "~/components/SyncData.svelte";

  let toastMsg = "";
  let isSuccessToast = false;
  let showToast = false;
  let counter = 3;

  const timeout = () => {
    if (--counter > 0) return setTimeout(timeout, 1000);
    showToast = false;
    toastMsg = "";
    isSuccessToast = false;
  };

  const trigger = () => {
    showToast = true;
    counter = 3;
    timeout();
  };

  const downloadPage = async () => {
    const targetElement = document.getElementById("target-performance-summary");
    const shareBtn = document.getElementById("btn-share-summary");
    if (targetElement && shareBtn) {
      try {
        await html2canvas(targetElement, {
          ignoreElements: (el) => {
            return el.id === "btn-share-summary";
          },
          proxy: "https://htmlcanvas-proxy.getnimbus.io",
          logging: true,
          scale: 2,
        }).then((canvas) => {
          const ctx = canvas.getContext("2d");
          ctx.imageSmoothingEnabled = true;
          const img = canvas
            .toDataURL("image/png")
            .replace("image/png", "image/octet-stream");
          const a = document.createElement("a");
          a.href = img;

          a.download = "UserPerformanceSummary.png";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          toastMsg = "Successfully downloaded!";
          isSuccessToast = true;
          trigger();
        });
      } catch (error) {
        console.error("Error capturing screenshot:", error);
        toastMsg = "Something wrong when download. Please try again!";
        isSuccessToast = false;
        trigger();
      }
    }
  };
</script>

<div
  class="max-w-[2000px] m-auto xl:w-[90%] w-[90%] py-8"
  id="target-performance-summary"
>
  <SyncData let:address let:enabledFetchAllData>
    <div class="flex flex-col gap-6">
      <div class="flex items-center justify-between">
        <Link to="/" class="cusor-pointer">
          <div class="flex items-center gap-1">
            <img
              src={$isDarkMode ? LeftArrow : LeftArrowBlack}
              alt=""
              class="xl:w-5 xl:h-5 w-7 h-7"
            />
            <div class="xl:text-sm text-2xl font-medium">Portfolio Detail</div>
          </div>
        </Link>

        <button
          id="btn-share-summary"
          class="flex items-center justify-center gap-2 xl:text-sm text-2xl font-medium text-white bg-[#27326f] px-4 py-2 rounded-xl"
          on:click={downloadPage}
        >
          Share
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 16 16"
            class="m-auto"
          >
            <rect width="16" height="16" fill="none" />
            <path
              fill="currentColor"
              d="M10.307 2.105A.5.5 0 0 0 9.5 2.5v1.993a5.372 5.372 0 0 0-1.679.344a4.693 4.693 0 0 0-2.095 1.574c-.623.826-1.081 1.972-1.224 3.544a.5.5 0 0 0 .852.399c1.188-1.19 2.369-1.776 3.242-2.067c.36-.12.668-.19.904-.23V10a.5.5 0 0 0 .832.374l4.5-4a.5.5 0 0 0-.025-.769zm-.364 3.392h.003A.502.502 0 0 0 10.5 5V3.522l3.219 2.504l-3.219 2.86V7.5A.5.5 0 0 0 10 7h-.045a4.775 4.775 0 0 0-.456.043c-.3.044-.72.128-1.22.295a8.895 8.895 0 0 0-2.547 1.36c.194-.716.476-1.264.793-1.685a3.693 3.693 0 0 1 1.654-1.242A4.373 4.373 0 0 1 9.82 5.49c.045.001.079.003.1.005zM4.5 3A2.5 2.5 0 0 0 2 5.5v6A2.5 2.5 0 0 0 4.5 14h6a2.5 2.5 0 0 0 2.5-2.5v-1a.5.5 0 0 0-1 0v1a1.5 1.5 0 0 1-1.5 1.5h-6A1.5 1.5 0 0 1 3 11.5v-6A1.5 1.5 0 0 1 4.5 4h2a.5.5 0 0 0 0-1z"
            />
          </svg>
        </button>
      </div>
      <div
        class="w-full flex xl:flex-row flex-col rounded-xl py-10 px-10 gap-9 border-2 border_0000001a"
      >
        <div class="xl:w-[20%] w-full flex flex-col gap-5 justify-between">
          <div>
            <div class="flex flex-col gap-3 items-center justify-start">
              <div class="xl:w-[80px] xl:h-[80px] w-32 h-32">
                <img src={User} alt="" class="object-cover w-full h-full" />
              </div>

              <div
                class={`text-2xl xl:text-base font-medium flex items-center gap-2 ${
                  $isDarkMode ? "text-white" : "text-black"
                }`}
              >
                {shorterAddress(address)}
              </div>
            </div>

            {#if Object.keys($user).length !== 0}
              <InviterQr />
            {/if}
          </div>
          <a
            class="hover:underline text-gray-500"
            href="https://getnimbus.io/"
            target="_blank"
          >
            https://getnimbus.io/
          </a>
        </div>
        <div class="flex-1 flex flex-col gap-4">
          <div class="xl:text-3xl text-4xl font-medium">
            Performance Summary
          </div>
          <div class="grid xl:grid-cols-4 grid-cols-2 gap-6">
            <ProfitData
              selectedAddress={address}
              isSync={true}
              {enabledFetchAllData}
            />

            <TopProfitAndLoss
              selectedAddress={address}
              isSync={true}
              {enabledFetchAllData}
            />

            <ClosedPositionChart
              selectedAddress={address}
              isSync={true}
              {enabledFetchAllData}
            />
          </div>
        </div>
      </div>
    </div>
  </SyncData>
</div>

<style windi:preflights:global windi:safelist:global>
  :global(img) {
    display: inline-block;
  }
</style>
